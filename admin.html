<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYOSİS Admin Paneli</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font Ailesi -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Tablo stilleri */
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
        }
        .data-table tbody tr:hover {
            background-color: #f1f5f9;
        }
    </style>
    
    <script>
        // Tailwind yapılandırması
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3730a3',
                            light: '#4338ca',
                            dark: '#312e81', 
                        },
                        secondary: {
                            DEFAULT: '#a21caf',
                            light: '#c026d3',
                            dark: '#86198f', 
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ===== Giriş Ekranı (Varsayılan) ===== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                <img src="logo(1).jpg" alt="TYOSİS Logo" class="h-16 w-16 object-contain mx-auto mb-4">
                <h1 class="text-2xl font-bold text-primary-dark">Admin Paneli Girişi</h1>
            </div>
            
            <form id="login-form" class.space-y-6>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">E-posta</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-3 rounded-lg border-gray-300 focus:border-primary focus:ring-primary-light" placeholder="admin@tyosis.com">
                </div>
                <div class="mt-4">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Şifre</label>
                    <input type="password" id="password" name="password" required class="w-full px-4 py-3 rounded-lg border-gray-300 focus:border-primary focus:ring-primary-light" placeholder="••••••••">
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full bg-primary text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition duration-300 shadow-lg">
                        Giriş Yap
                    </button>
                </div>
            </form>
            <div id="login-error" class="mt-4 text-center text-red-600 font-medium"></div>
            <p class="text-xs text-gray-500 mt-6 text-center">
                Not: Lütfen Firebase konsolundan manuel olarak oluşturduğunuz admin hesabınızla giriş yapın.
            </p>
        </div>
    </div>

    <!-- ===== Admin Paneli (Giriş Yapılınca) ===== -->
    <div id="admin-panel" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="flex items-center space-x-2">
                    <img src="logo(1).jpg" alt="TYOSİS Logo" class="h-10 w-10 object-contain">
                    <span class="text-lg font-bold text-primary-dark">TYOSİS Admin Paneli</span>
                </a>
                <div>
                    <span id="admin-email" class="text-gray-600 mr-4"></span>
                    <button id="logout-button" class="bg-secondary text-white px-5 py-2 rounded-lg font-medium hover:bg-secondary-dark transition duration-300 shadow-sm">
                        Çıkış Yap
                    </button>
                </div>
            </nav>
        </header>

        <!-- İçerik -->
        <main class="container mx-auto px-6 py-12">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">Gelen Talepler</h1>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <p id="loading-message" class="text-lg text-gray-600">Talepler yükleniyor...</p>
                <div id="requests-list" class="overflow-x-auto">
                    <!-- Talepler buraya dinamik olarak eklenecek -->
                </div>
            </div>
        </main>
    </div>

    <!-- ===== Firebase ve Admin JS ===== -->
    <script type="module">
        // Firebase modüllerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot,
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase'i başlat
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Firebase loglarını konsolda görmek için
        setLogLevel('Debug');

        // DOM Elementleri
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const adminEmail = document.getElementById('admin-email');
        const requestsList = document.getElementById('requests-list');
        const loadingMessage = document.getElementById('loading-message');

        let dbRef = null;
        let unsubscribe = null; // onSnapshot dinleyicisini kapatmak için

        // Oturum durumunu dinle
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Admin giriş yapmış
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                adminEmail.textContent = user.email;
                
                // Veritabanı referansını ayarla
                dbRef = collection(db, 'artifacts', appId, 'public', 'data', 'requests');
                
                // Talepleri dinle
                listenForRequests();

            } else {
                // Admin çıkış yapmış
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                adminEmail.textContent = '';
                
                // onSnapshot dinleyicisini durdur (eğer aktifse)
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
            }
        });

        // Giriş Formu
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged geri kalanı halledecek
            } catch (error) {
                console.error("Giriş hatası:", error);
                loginError.textContent = 'Giriş başarısız. E-posta veya şifre hatalı.';
            }
        });

        // Çıkış Butonu
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Çıkış hatası:", error);
            }
        });

        // Firestore'dan talepleri dinle
        function listenForRequests() {
            if (!dbRef) return;
            
            const q = query(dbRef); // 'orderBy' index gerektirdiği için kaldırıldı

            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                if (snapshot.empty) {
                    requestsList.innerHTML = '<p class="text-gray-500">Henüz kayıtlı bir talep bulunmuyor.</p>';
                    return;
                }

                let requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                
                // Verileri JS içinde tarihe göre sırala (en yeni üstte)
                requests.sort((a, b) => {
                    const timeA = a.createdAt?.toDate() || 0;
                    const timeB = b.createdAt?.toDate() || 0;
                    return timeB - timeA;
                });

                renderRequests(requests);

            }, (error) => {
                console.error("Veri okuma hatası:", error);
                loadingMessage.textContent = 'Talepler yüklenirken bir hata oluştu.';
                loadingMessage.classList.remove('hidden');
            });
        }

        // Talepleri HTML olarak render et
        function renderRequests(requests) {
            let html = `
                <table class="w-full data-table">
                    <thead>
                        <tr>
                            <th>Tür</th>
                            <th>Tarih</th>
                            <th>Ad Soyad</th>
                            <th>Telefon</th>
                            <th>E-posta</th>
                            <th>Sektör/Konu</th>
                            <th>Mesaj</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            requests.forEach(req => {
                html += `
                    <tr>
                        <td class="font-medium text-primary">${formatType(req.type)}</td>
                        <td>${formatDate(req.createdAt)}</td>
                        <td>${req.name || '-'}</td>
                        <td>${req.phone || '-'}</td>
                        <td>${req.email || '-'}</td>
                        <td>${req.sector || req.subject || '-'}</td>
                        <td class="text-sm text-gray-600">${req.message || '-'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            requestsList.innerHTML = html;
        }

        // Yardımcı fonksiyonlar
        function formatType(type) {
            if (type === 'chat') return 'Chat Botu';
            if (type === 'demo_form') return 'Demo Formu';
            // DÜZELTİLDİ:
            if (type === 'contact_form') return 'İletişim Formu';
            return type;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Bilinmiyor';
            const date = timestamp.toDate();
            return date.toLocaleString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

    </script>

</body>
</html>
